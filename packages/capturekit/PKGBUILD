#!/bin/bash

OS=$(uname)
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# --- OS Validation ---
if [ "$OS" == "Darwin" ]; then
    echo "Running on macOS..."
elif [ "$OS" == "Linux" ]; then
    echo "Running on Linux..."
else
    echo "This script must be run on Linux or macOS."
    exit 1
fi

# --- Clean ---
if [ "$1" == "clean" ]; then
    echo "Cleaning build and dist directories..."
    rm -rf "$DIR/build" "$DIR/dist"
    echo "Clean finished."
    exit 0
fi

# --- Platform-specific Setup ---
if [ "$OS" == "Darwin" ]; then
    # macOS Qt paths
    QMAKE_PATH=$(command -v qmake)
    if [ -z "$QMAKE_PATH" ]; then
        echo "Error: qmake not found in PATH. Please ensure Qt is installed and qmake is accessible."
        exit 1
    fi

    QT_PLUGIN_PATH=$($QMAKE_PATH -query QT_INSTALL_PLUGINS)
    QT_BIN_PATH=$($QMAKE_PATH -query QT_INSTALL_BINS)
    MACDEPLOYQT="$QT_BIN_PATH/macdeployqt"

    if [ ! -x "$MACDEPLOYQT" ]; then
        echo "Error: macdeployqt not found at $MACDEPLOYQT. Please ensure Qt is installed correctly."
        exit 1
    fi

    echo "Using QT_PLUGIN_PATH=$QT_PLUGIN_PATH"
    echo "Using MACDEPLOYQT=$MACDEPLOYQT"
else
    # Linux Qt plugin and lib prefix (x86_64)
    CANDS=(
      "/usr/lib/x86_64-linux-gnu/qt6/plugins"   # Debian/Ubuntu/Mint/Pop
      "/usr/lib64/qt6/plugins"                  # Fedora/openSUSE/RHEL
      "/usr/lib/qt6/plugins"                    # Arch/Manjaro
    )

    QT_PLUGIN_PATH=""
    for p in "${CANDS[@]}"; do
      if [ -d "$p" ]; then
        QT_PLUGIN_PATH="$p"
        break
      fi
    done

    if [ -z "$QT_PLUGIN_PATH" ]; then
      echo "Warning: QT plugin dir not found in known locations; please set QT_PLUGIN_PATH manually."
    else
      export QT_PLUGIN_PATH
      echo "Using QT_PLUGIN_PATH=$QT_PLUGIN_PATH"
    fi
fi

# --- Build ---
echo "--- Starting build ---"
mkdir -p "$DIR/build"
cd "$DIR/build" || { echo "Failed to cd to build dir"; exit 1; }

echo "# Automatically generated by SpatialShot" > .gitignore
echo "*" >> .gitignore

echo "Running CMake..."
cmake "$DIR/src"
if [ $? -ne 0 ]; then
    echo "CMake failed. Aborting."
    exit 1
fi

echo "Running make..."
make
if [ $? -ne 0 ]; then
    echo "make failed. Aborting."
    exit 1
fi

cd "$DIR" || { echo "Failed to cd back to root dir"; exit 1; }
echo "--- Build finished ---"

# --- Staging/Distribution ---
echo "--- Staging distribution files ---"
mkdir -p "$DIR/dist"

cd "$DIR/dist"
echo "# Automatically generated by SpatialShot" > .gitignore
echo "*" >> .gitignore
cd "$DIR" || { echo "Failed to cd back to root dir"; exit 1; }

echo "Copying qt.conf..."
cp "$DIR/bundle/qt.conf" "$DIR/dist/"

# Platform-specific wrapper handling
if [ "$OS" == "Darwin" ]; then
    echo "Creating macOS wrappers..."
    cat << EOF > "$DIR/dist/scgrabber"
#!/usr/bin/env bash
DIR="\$( cd "\$( dirname "\${BASH_SOURCE[0]}" )" && pwd )"
export QT_DEBUG_PLUGINS=1
exec "\$DIR/scgrabber-bin" "\$@"
EOF

    cat << EOF > "$DIR/dist/drawview"
#!/usr/bin/env bash
DIR="\$( cd "\$( dirname "\${BASH_SOURCE[0]}" )" && pwd )"
export QT_DEBUG_PLUGINS=1
exec "\$DIR/drawview-bin" "\$@"
EOF
else
    echo "Copying Linux wrappers..."
    cp "$DIR/bundle/drawview" "$DIR/dist/"
    cp "$DIR/bundle/scgrabber" "$DIR/dist/"
fi

chmod +x "$DIR/dist/drawview"
chmod +x "$DIR/dist/scgrabber"

echo "Copying binaries..."
cp "$DIR/build/drawview-bin" "$DIR/dist/"
cp "$DIR/build/scgrabber-bin" "$DIR/dist/"
chmod +x "$DIR/dist/drawview-bin"
chmod +x "$DIR/dist/scgrabber-bin"
echo "--- Staging finished ---"

# --- Platform-specific Dependency Bundling ---
if [ "$OS" == "Darwin" ]; then
    # --- macOS: Bundle with macdeployqt ---
    echo "--- Bundling dependencies with macdeployqt ---"
    BINARIES=("scgrabber-bin" "drawview-bin")

    for bin in "${BINARIES[@]}"; do
        rm -rf temp.app
        mkdir -p temp.app/Contents/MacOS
        cp "$DIR/dist/$bin" temp.app/Contents/MacOS/
        "$MACDEPLOYQT" temp.app -executable=temp.app/Contents/MacOS/$bin -always-overwrite
        if [ $? -ne 0 ]; then
            echo "macdeployqt failed for $bin. Aborting."
            exit 1
        fi

        cp temp.app/Contents/MacOS/$bin "$DIR/dist/$bin"

        if [ -d temp.app/Contents/Frameworks ]; then
            mkdir -p "$DIR/dist/Frameworks"
            cp -r temp.app/Contents/Frameworks/* "$DIR/dist/Frameworks/"
        fi

        if [ -d temp.app/Contents/PlugIns ]; then
            mkdir -p "$DIR/dist/plugins"
            cp -r temp.app/Contents/PlugIns/* "$DIR/dist/plugins/"
        fi

        if [ -f temp.app/Contents/Resources/qt.conf ]; then
            cp temp.app/Contents/Resources/qt.conf "$DIR/dist/qt.conf"
        fi

        rm -rf temp.app
    done

    if [ ! -f "$DIR/dist/qt.conf" ]; then
        echo "[Paths]" > "$DIR/dist/qt.conf"
        echo "Prefix = ." >> "$DIR/dist/qt.conf"
        echo "Plugins = plugins" >> "$DIR/dist/qt.conf"
    else
        echo "[Paths]" > "$DIR/dist/qt.conf"
        echo "Prefix = ." >> "$DIR/dist/qt.conf"
        echo "Plugins = plugins" >> "$DIR/dist/qt.conf"
    fi

    echo "--- Bundling finished ---"
else
    # --- Linux: Manual library and plugin copying ---
    
    # --- Qt Plugins ---
    echo "--- Copying Qt plugins ---"
    PLUGIN_DIR="$DIR/dist/plugins"

    mkdir -p "$PLUGIN_DIR"

    if [ -d "$QT_PLUGIN_PATH/platforms" ]; then
        echo "Copying platforms..."
        cp -rL "$QT_PLUGIN_PATH/platforms" "$PLUGIN_DIR/"
    else
        echo "Warning: platforms dir not found at $QT_PLUGIN_PATH"
    fi

    if [ -d "$QT_PLUGIN_PATH/imageformats" ]; then
        echo "Copying imageformats..."
        cp -rL "$QT_PLUGIN_PATH/imageformats" "$PLUGIN_DIR/"
    else
        echo "Warning: imageformats dir not found at $QT_PLUGIN_PATH"
    fi

    if [ -d "$QT_PLUGIN_PATH/generic" ]; then
        echo "Copying generic..."
        cp -rL "$QT_PLUGIN_PATH/generic" "$PLUGIN_DIR/"
    else
        echo "Warning: generic dir not found at $QT_PLUGIN_PATH"
    fi
    echo "--- Qt plugins copied ---"

    # --- Library Dependencies ---
    echo "--- Copying library dependencies ---"
    
    # set DBUS/DBUS lib path detection (64-bit)
    if [ -f "/usr/lib/x86_64-linux-gnu/libdbus-1.so.3" ]; then
      DBUS_LIB="/usr/lib/x86_64-linux-gnu/libdbus-1.so.3"
    elif [ -f "/usr/lib64/libdbus-1.so.3" ]; then
      DBUS_LIB="/usr/lib64/libdbus-1.so.3"
    elif [ -f "/usr/lib/libdbus-1.so.3" ]; then
      DBUS_LIB="/usr/lib/libdbus-1.so.3"
    else
      DBUS_LIB=""
    fi

    BINARIES=("$DIR/dist/scgrabber-bin" "$DIR/dist/drawview-bin")
    LIB_DIR="$DIR/dist/libs"
    mkdir -p "$LIB_DIR"

    SKIP_LIBS=(
        "linux-vdso.so.1" "libstdc++.so.6" "libgcc_s.so.1" "libc.so.6" "libm.so.6"
        "/lib64/ld-linux-x86-64.so.2" "libpcre2-8.so.0" "libsystemd.so.0" "libcap.so.2"
        "libgcrypt.so.20" "liblz4.so.1" "liblzma.so.5" "libmd.so.0" "libgpg-error.so.0"
    )

    copy_deps() {
        local file="$1"
        if [ ! -f "$file" ]; then
            echo "Warning: Binary $file not found. Skipping ldd scan."
            return
        fi
        ldd "$file" | grep "=>" | awk '{print $3}' | while read -r lib; do
            if [ -n "$lib" ] && [ -f "$lib" ]; then
                lib_name=$(basename "$lib")
                if [ -f "$LIB_DIR/$lib_name" ]; then continue; fi
                skip=false
                for skip_lib in "${SKIP_LIBS[@]}"; do
                    if [[ "$lib_name" == "$skip_lib" ]]; then
                        skip=true
                        break
                    fi
                done
                if ! $skip; then
                    echo "Copying $lib to $LIB_DIR"
                    cp -L "$lib" "$LIB_DIR/"
                else
                    echo "Skipping system lib: $lib_name"
                fi
            fi
        done
    }

    for bin in "${BINARIES[@]}"; do
        copy_deps "$bin"
    done

    XCB_LIB_BASENAMES=(
        "libxcb-cursor.so.0" "libxcb-icccm.so.4"  "libxcb-image.so.0"  "libxcb-keysyms.so.1"
        "libxcb-randr.so.0"  "libxcb-shm.so.0"    "libxcb-sync.so.1"   "libxcb-xinerama.so.0"
        "libwebpdemux.so.2"  "libwebp.so.7"       "libjpeg.so.8"       "libxcb-render-util.so.0"
        "libxcb-xfixes.so.0" "libmng.so.2"        "libxcb-xkb.so.1"    "libxkbcommon-x11.so.0"
        "libxkbcommon.so.0"  "libX11.so.6"        "libXdamage.so.1"    "libXcomposite.so.1"
        "libXfixes.so.3"     "libpng16.so.16"     "libtiff.so.6"       "libQt6Svg.so.6"
        "libXcursor.so.1"    "libXext.so.6"       "libfontconfig.so.1" "libfreetype.so.6"
        "libQt6XcbQpa.so.6"  "libxcb-render.so.0" "libxcb-shape.so.0"  "libX11-xcb.so.1"
        "libSM.so.6"         "libICE.so.6"        "libxcb-util.so.1"   "libXrender.so.1"
        "liblcms2.so.2"
    )

    LIB_PREFIXES=("/usr/lib/x86_64-linux-gnu" "/usr/lib64" "/usr/lib")
    FOUND_PREFIX=""

    # Detect the library prefix
    for prefix in "${LIB_PREFIXES[@]}"; do
        if [ -f "$prefix/libxcb-cursor.so.0" ]; then
            FOUND_PREFIX="$prefix"
            break
        fi
    done

    if [ -n "$FOUND_PREFIX" ]; then
        echo "Found library prefix for XCB libs: $FOUND_PREFIX"
        for lib_basename in "${XCB_LIB_BASENAMES[@]}"; do
            candidate="$FOUND_PREFIX/$lib_basename"
            if [ -f "$candidate" ]; then
                lib_name=$(basename "$candidate")
                if [ ! -f "$LIB_DIR/$lib_name" ]; then
                    echo "Copying xcb dep $candidate (dereferenced) to $LIB_DIR"
                    cp -L "$candidate" "$LIB_DIR/"
                fi
            else
                 echo "Warning: $lib_basename not found in $FOUND_PREFIX, skipping"
            fi
        done
    else
        echo "Warning: Could not determine library prefix for XCB libs. They will likely be missing."
    fi

    if [ -n "$DBUS_LIB" ] && [ -f "$DBUS_LIB" ]; then
        lib_name=$(basename "$DBUS_LIB")
        if [ ! -f "$LIB_DIR/$lib_name" ]; then
            echo "Copying DBus lib $DBUS_LIB to $LIB_DIR"
            cp -L "$DBUS_LIB" "$LIB_DIR/"
        fi
    else
        echo "Warning: DBus library not found."
    fi

    mkdir -p "$DIR/dist/fonts"
    if [ -f /etc/fonts/fonts.conf ]; then
        cp /etc/fonts/fonts.conf "$DIR/dist/fonts/"
    fi
    echo "--- Library dependencies copied ---"
fi

echo "All tasks completed."