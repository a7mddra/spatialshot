#!/bin/bash
# This script is run by the GitHub Actions runner
set -e
echo "--- Building macOS Installer ---"

echo "Downloading and unzipping Platypus..."
curl -L -o platypus.zip https://sveinbjorn.org/files/software/platypus/platypus.zip
unzip -q platypus.zip

PLATYPUS_CLI="./Platypus.app/Contents/Resources/platypus"
chmod +x "$PLATYPUS_CLI"
chmod +x packaging/macos/installer.sh

echo "Running Platypus to create .app..."
"$PLATYPUS_CLI" -A -t "Text Window" \
               -o "Install SpatialShot.app" \
               "packaging/macos/installer.sh"

echo "Creating .dmg..."
hdiutil create -srcfolder "Install SpatialShot.app" \
               -volname "Install SpatialShot" \
               -fs HFS+ \
               -format UDZO \
               spatialshot-installer.dmg

echo "--- macOS Installer Built ---"