#!/bin/bash
# This script is run by the GitHub Actions runner
set -e
echo "--- Building macOS Installer ---"
PLATYPUS_VERSION="5.4.1"
PLATYPUS_URL="https://sveinbjorn.org/files/software/platypus.zip"
# --- 1. Download Platypus ---
if [ ! -d "Platypus.app" ]; then
    echo "Downloading Platypus v${PLATYPUS_VERSION}..."
    curl -L -A "Mozilla/5.0" -o platypus.zip "$PLATYPUS_URL"
   
    FILE_SIZE=$(stat -f%z platypus.zip)
    if [ "$FILE_SIZE" -lt 1000000 ]; then
        echo "Error: Downloaded file is too small ($FILE_SIZE bytes)."
        cat platypus.zip
        exit 1
    fi
    echo "Unzipping Platypus..."
    unzip -q -o platypus.zip
   
    # Locate the actual app bundle (handles nested folders)
    PLATYPUS_APP_PATH=$(find . -name "Platypus.app" -type d | head -n 1)
    if [ -z "$PLATYPUS_APP_PATH" ]; then
        echo "Error: Could not find Platypus.app after unzipping."
        exit 1
    fi
    if [ "$PLATYPUS_APP_PATH" != "./Platypus.app" ]; then
        mv "$PLATYPUS_APP_PATH" .
    fi
fi
# --- 2. Prepare CLI Tool & Environment ---
GZIPPED_CLI="./Platypus.app/Contents/Resources/platypus_clt.gz"
PLATYPUS_CLI="./Platypus.app/Contents/Resources/platypus"
if [ -f "$GZIPPED_CLI" ]; then
    echo "Decompressing Platypus CLI..."
    gunzip -c "$GZIPPED_CLI" > "$PLATYPUS_CLI"
fi

# Decompress ScriptExec.gz
GZIPPED_SCRIPT_EXEC="./Platypus.app/Contents/Resources/ScriptExec.gz"
SCRIPT_EXEC="./Platypus.app/Contents/Resources/ScriptExec"
if [ -f "$GZIPPED_SCRIPT_EXEC" ]; then
    echo "Decompressing ScriptExec..."
    gunzip -c "$GZIPPED_SCRIPT_EXEC" > "$SCRIPT_EXEC"
    chmod +x "$SCRIPT_EXEC"  # Optional: Ensure it's executable after decompression
fi

# Locate the CLI binary if not at standard path
if [ ! -f "$PLATYPUS_CLI" ]; then
    echo "Searching for platypus binary..."
    PLATYPUS_CLI=$(find Platypus.app -name "platypus" -type f | head -n 1)
fi
if [ -z "$PLATYPUS_CLI" ] || [ ! -f "$PLATYPUS_CLI" ]; then
    echo "Error: Platypus CLI binary not found."
    exit 1
fi
chmod +x "$PLATYPUS_CLI"
echo "Found Platypus CLI at: $PLATYPUS_CLI"
# --- 3. Install Helper Files (The Fix) ---
echo "Installing Platypus resources to /usr/local/share/platypus..."
sudo mkdir -p /usr/local/share/platypus
# Dynamically find ScriptExec (The app wrapper binary)
SCRIPT_EXEC_PATH=$(find Platypus.app -name "ScriptExec" -type f | head -n 1)
if [ -z "$SCRIPT_EXEC_PATH" ]; then
    echo "❌ Error: 'ScriptExec' file not found inside Platypus.app"
    echo "Listing contents of Platypus.app/Contents/Resources for debugging:"
    ls -R Platypus.app/Contents/Resources
    exit 1
fi
echo "Found ScriptExec at: $SCRIPT_EXEC_PATH"
sudo cp "$SCRIPT_EXEC_PATH" /usr/local/share/platypus/
# Dynamically find MainMenu.nib (The Interface layout)
NIB_PATH=$(find Platypus.app -name "MainMenu.nib" | head -n 1)
if [ -n "$NIB_PATH" ]; then
    echo "Found MainMenu.nib at: $NIB_PATH"
    sudo cp -R "$NIB_PATH" /usr/local/share/platypus/
else
    echo "⚠️ Warning: MainMenu.nib not found. Text Window interface might fail."
fi
# --- 4. Build the App ---
INSTALLER_SCRIPT="packaging/macos/installer.sh"
chmod +x "$INSTALLER_SCRIPT"
APP_NAME="Install SpatialShot.app"
ICON_PATH="packaging/macos/icon.icns"
echo "Running Platypus to create .app..."
CMD_ARGS=(
    "-A"
    "-o" "Text Window"
    "$INSTALLER_SCRIPT"
    "$APP_NAME"
)
# Only add icon flag if file actually exists
if [ -f "$ICON_PATH" ]; then
    echo "Using icon: $ICON_PATH"
    CMD_ARGS=("${CMD_ARGS[@]:0:3}" "-i" "$ICON_PATH" "${CMD_ARGS[@]:3}")
else
    echo "⚠️ Warning: Icon not found at '$ICON_PATH'. Using default icon."
fi
# Execute Platypus
"$PLATYPUS_CLI" "${CMD_ARGS[@]}"
# --- 5. Create DMG ---
echo "Creating .dmg..."
rm -f spatialshot-installer.dmg
hdiutil create -srcfolder "$APP_NAME" \
               -volname "Install SpatialShot" \
               -fs HFS+ \
               -format UDZO \
               spatialshot-installer.dmg
echo "--- macOS Installer Built Successfully ---"