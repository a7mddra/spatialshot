name: 'Build SpatialShot'
description: 'Builds Electron App with Credentials'
inputs:
  google_credentials:
    required: true
  gh_token:
    required: true
  npm_script:
    required: true
  artifact_path:
    required: true

runs:
  using: "composite"
  steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'

    - name: Install Core Dependencies
      working-directory: ./packages/core
      shell: bash
      run: |
        npm ci
        npm install --no-save @types/node

    - name: Build Core
      working-directory: ./packages/core
      shell: bash
      run: npm run build

    - name: Transfer Core Dist to Renderer View
      shell: bash
      run: |
        CORE_DIST="packages/core/dist"
        VIEW_DIR="packages/spatialshot/source/renderer/view"
        
        rm -rf "$VIEW_DIR"
        mkdir -p "$VIEW_DIR"
        cp -r "$CORE_DIST"/* "$VIEW_DIR"/

    - name: Inject Google Credentials
      shell: bash
      working-directory: ./packages/spatialshot/source/auth
      env:
        CREDENTIALS_CONTENT: ${{ inputs.google_credentials }}
      run: |
        if [ -z "$CREDENTIALS_CONTENT" ]; then
          echo "::error::Credentials input is empty!"
          exit 1
        fi
        printf "%s" "$CREDENTIALS_CONTENT" > credentials.json
        echo "Successfully injected credentials.json"

    - name: Install SpatialShot Dependencies
      working-directory: ./packages/spatialshot
      shell: bash
      run: npm ci

    - name: Build Electron
      working-directory: ./packages/spatialshot
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.gh_token }}
      run: npm run ${{ inputs.npm_script }} -- -p never

    - name: Stage Artifacts
      shell: bash
      run: |
        mkdir -p dist-out
        if [ -d "${{ inputs.artifact_path }}" ]; then
           cp -r ${{ inputs.artifact_path }}/* dist-out/
        else
           cp -r ${{ inputs.artifact_path }} dist-out/
        fi
