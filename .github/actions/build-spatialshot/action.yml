name: "Build Spatialshot"
description: "Builds Electron App with Credentials"
inputs:
  google_credentials:
    required: true
  gh_token:
    required: true
  npm_script:
    required: true
  artifact_path:
    required: true
  platform:
    required: true
    description: "win, mac, or linux"

runs:
  using: "composite"
  steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: "npm"
        cache-dependency-path: "**/package-lock.json"

    # --- CORE BUILD ---
    - name: Install Core Dependencies
      working-directory: ./packages/core
      shell: bash
      run: |
        npm ci
        npm install --no-save @types/node
        npm run build

    # --- TRANSFER LOGIC ---
    - name: Transfer Core Dist to Renderer View
      shell: bash
      run: |
        CORE_DIST="packages/core/dist"
        VIEW_DIR="packages/spatialshot/src/renderer/view"

        rm -rf "$VIEW_DIR"
        mkdir -p "$VIEW_DIR"
        cp -r "$CORE_DIST"/* "$VIEW_DIR"/
        printf "# Auto-generated by CI\n*\n!.gitignore\n" > "$VIEW_DIR/.gitignore"

    # --- INJECT CREDENTIALS ---
    - name: Inject Google Credentials
      shell: bash
      working-directory: ./packages/spatialshot/src/auth
      env:
        CREDENTIALS_CONTENT: ${{ inputs.google_credentials }}
      run: |
        if [ -z "$CREDENTIALS_CONTENT" ]; then
          echo "::error::Credentials input is empty!"
          exit 1
        fi
        printf "%s" "$CREDENTIALS_CONTENT" > credentials.json

    # --- ELECTRON BUILD ---
    - name: Install Spatialshot Dependencies
      working-directory: ./packages/spatialshot
      shell: bash
      run: npm ci

    - name: Patch package.json with Repository
      working-directory: ./packages/spatialshot
      shell: bash
      run: |
        REPO_URL="https://github.com/${{ github.repository }}"
        echo "Patching package.json with repo: $REPO_URL"
        npm pkg set repository.type="git"
        npm pkg set repository.url="$REPO_URL"

    - name: Build Electron
      working-directory: ./packages/spatialshot
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.gh_token }}
      run: npm run ${{ inputs.npm_script }} -- -p never -c.mac.identity=null

    - name: Zip Artifacts
      shell: bash
      run: |
        DIST_ROOT="$GITHUB_WORKSPACE/dist-out"
        mkdir -p "$DIST_ROOT"

        ZIP_NAME="spatialshot-${{ inputs.platform }}-x64.zip"
        ZIP_FULL_PATH="$DIST_ROOT/$ZIP_NAME"

        TARGET_PATH=$(ls -d ${{ inputs.artifact_path }} 2>/dev/null | head -n 1)

        if [ -z "$TARGET_PATH" ]; then
          echo "::error::Artifact path not found: ${{ inputs.artifact_path }}"
          ls -R packages/spatialshot/dist/ || true
          exit 1
        fi

        echo "Zipping $TARGET_PATH to $ZIP_FULL_PATH"

        if [ -d "$TARGET_PATH" ]; then
          cd "$TARGET_PATH"
          if [ "$RUNNER_OS" == "Windows" ]; then
            7z a -tzip -r "$ZIP_FULL_PATH" .
          else
            zip -r "$ZIP_FULL_PATH" .
          fi
        else
          cp "$TARGET_PATH" "$DIST_ROOT/"
        fi

        ls -l "$DIST_ROOT"
