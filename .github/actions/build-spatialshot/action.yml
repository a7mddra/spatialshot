name: 'Build SpatialShot'
description: 'Builds Electron App with Credentials'
inputs:
  google_credentials:
    required: true
  gh_token:
    required: true
  npm_script:
    required: true
  artifact_path:
    required: true
  platform:
    required: true
    description: 'win, mac, or linux'

runs:
  using: "composite"
  steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'

    # --- CORE BUILD ---
    - name: Install Core Dependencies
      working-directory: ./packages/core
      shell: bash
      run: |
        npm ci
        npm install --no-save @types/node
        npm run build

    # --- TRANSFER LOGIC ---
    - name: Transfer Core Dist to Renderer View
      shell: bash
      run: |
        CORE_DIST="packages/core/dist"
        VIEW_DIR="packages/spatialshot/source/renderer/view"
        
        rm -rf "$VIEW_DIR"
        mkdir -p "$VIEW_DIR"
        cp -r "$CORE_DIST"/* "$VIEW_DIR"/
        printf "# Auto-generated by CI\n*\n!.gitignore\n" > "$VIEW_DIR/.gitignore"

    # --- INJECT CREDENTIALS ---
    - name: Inject Google Credentials
      shell: bash
      working-directory: ./packages/spatialshot/source/auth
      env:
        CREDENTIALS_CONTENT: ${{ inputs.google_credentials }}
      run: |
        if [ -z "$CREDENTIALS_CONTENT" ]; then
          echo "::error::Credentials input is empty!"
          exit 1
        fi
        printf "%s" "$CREDENTIALS_CONTENT" > credentials.json

    # --- ELECTRON BUILD ---
    - name: Install SpatialShot Dependencies
      working-directory: ./packages/spatialshot
      shell: bash
      run: npm ci

    - name: Build Electron
      working-directory: ./packages/spatialshot
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.gh_token }}
      run: npm run ${{ inputs.npm_script }} -- -p never

    # --- STAGE & ZIP ---
    - name: Zip Artifacts
      shell: bash
      run: |
        mkdir -p dist-out
        
        # Determine unique zip name
        ZIP_NAME="spatialshot-${{ inputs.platform }}-portable.zip"
        
        echo "Zipping artifact from: ${{ inputs.artifact_path }}"
        
        # Navigate to the parent of the artifact path to zip cleanly
        # If artifact_path is "dist/win-unpacked", we want to zip the *contents* of win-unpacked
        
        if [ -d "${{ inputs.artifact_path }}" ]; then
          cd "${{ inputs.artifact_path }}"
          if [ "$RUNNER_OS" == "Windows" ]; then
            7z a -tzip -r "../../../../../dist-out/$ZIP_NAME" .
          else
            zip -r "../../../../../dist-out/$ZIP_NAME" .
          fi
        else
          # It's a single file (like a DMG/AppImage), just copy it
          cp "${{ inputs.artifact_path }}" "dist-out/"
        fi
        
        ls -l dist-out/