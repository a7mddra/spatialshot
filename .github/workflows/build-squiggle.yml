name: Build Squiggle (Cross-Platform)

on:
  push:
  # workflow_dispatch:

env:
  QT_VERSION: 6.8.0

jobs:
  build-qt-linux:
    runs-on: ubuntu-latest
    outputs:
      qt-install-dir: ${{ steps.set-qt-dir.outputs.qt-install-dir }}
    steps:
      - uses: actions/checkout@v4

      - name: Set QT_INSTALL_DIR
        id: set-qt-dir
        run: echo "qt-install-dir=${{ runner.temp }}/qt-static-linux" >> $GITHUB_OUTPUT

      - name: Cache Qt (Linux)
        id: cache-qt
        uses: actions/cache@v4
        with:
          path: ${{ steps.set-qt-dir.outputs.qt-install-dir }}
          key: qt-static-linux-squiggle-${{ env.QT_VERSION }}-${{ hashFiles('.github/actions/build-qt-squiggle/action.yml') }}-v3 # Bump version for -qt-xcb
          restore-keys: |
            qt-static-linux-squiggle-${{ env.QT_VERSION }}-

      - name: Build static Qt (Linux)
        if: ${{ steps.cache-qt.outputs.cache-hit != 'true' }}
        uses: ./.github/actions/build-qt-squiggle
        with:
          version: ${{ env.QT_VERSION }}
          configure-args: "-opensource -confirm-license -no-pch -skip qtwebengine -nomake tests -nomake examples -no-opengl -no-dbus -no-icu -no-glib -no-fontconfig -qt-libjpeg -qt-libpng -qt-freetype -qt-zlib -qt-pcre -qt-harfbuzz -bundled-xcb-xinput -qt-xcb"
          dir: ${{ steps.set-qt-dir.outputs.qt-install-dir }}
          submodules: "qtbase,qttools,qtimageformats"  # Removed unnecessary qtdeclarative, qtshadertools

  build-qt-windows:
    runs-on: windows-latest
    outputs:
      qt-install-dir: ${{ steps.set-qt-dir.outputs.qt-install-dir }}
    steps:
      - uses: actions/checkout@v4

      - name: Set QT_INSTALL_DIR
        id: set-qt-dir
        run: echo "qt-install-dir=${{ runner.temp }}\qt-static-windows" >> $env:GITHUB_OUTPUT

      - name: Cache Qt (Windows)
        id: cache-qt
        uses: actions/cache@v4
        with:
          path: ${{ steps.set-qt-dir.outputs.qt-install-dir }}
          key: qt-static-windows-squiggle-${{ env.QT_VERSION }}-${{ hashFiles('.github/actions/build-qt-squiggle/action.yml') }}-v4  # Bump to v4 for clean src handling
          restore-keys: |
            qt-static-windows-squiggle-${{ env.QT_VERSION }}-

      - name: Install dependencies (Windows)
        if: ${{ steps.cache-qt.outputs.cache-hit != 'true' }}
        shell: powershell
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          for ($retry = 1; $retry -le 3; $retry++) {
            choco install strawberryperl ninja llvm jom --yes --no-progress --limit-output
            if ($LASTEXITCODE -eq 0) { break }
            Write-Output "Retry $retry of 3 failed for choco install. Waiting 10 seconds..."
            Start-Sleep -Seconds 10
          }
          if ($LASTEXITCODE -ne 0) {
            Write-Output "Failed to install dependencies after 3 retries. Exiting."
            exit 1
          }

      - name: Setup MSVC environment
        if: ${{ steps.cache-qt.outputs.cache-hit != 'true' }}
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
          vsversion: 2022

      - name: Build static Qt from source (Windows)
        if: ${{ steps.cache-qt.outputs.cache-hit != 'true' }}
        shell: bash
        run: |
          set -e
          SRC_DIR="${{ steps.set-qt-dir.outputs.qt-install-dir }}/src"
          mkdir -p "$SRC_DIR"
          cd "$SRC_DIR"
          rm -rf qt5  # Ensure clean clone
          git clone --depth 1 -b "v${{ env.QT_VERSION }}" https://code.qt.io/qt/qt5.git
          cd qt5
          perl init-repository -f  # Force init; ignore subset for now to avoid extra pulls
          # Standard submodule update to avoid subset quirks pulling extras
          git submodule update --init --recursive --depth 1
          # Remove unnecessary modules for your Widgets-only app (reduces build time/size)
          rm -rf qtdeclarative qtshadertools qtsvg qtlanguageserver qtactiveqt qtcharts qtconnectivity qtdatavis3d qtdoc qtlocation qtmultimedia qtquickcontrols2 qtscxml qtsensors qtserialbus qtspeech qtsvg qttest qtxmlpatterns qt3d qtcanvas3d
          # Create clean build dir
          BUILD_DIR="../build"
          rm -rf "$BUILD_DIR" || true
          mkdir -p "$BUILD_DIR"
          cd "$BUILD_DIR"
          # Configure for static, minimal build
          ../qt5/configure.bat -static -opensource -confirm-license -no-pch -skip qtwebengine -nomake tests -nomake examples -make libs -cmake-generator Ninja -prefix "${{ steps.set-qt-dir.outputs.qt-install-dir }}" -platform win32-msvc -qt-zlib -qt-libpng -qt-libjpeg -qt-freetype -qt-pcre -qt-harfbuzz
          cmake --build . --parallel
          cmake --install .

      - name: Clean .prl files (remove absolute build paths and .o file libs)
        if: ${{ steps.cache-qt.outputs.cache-hit != 'true' }}
        shell: powershell
        working-directory: ${{ steps.set-qt-dir.outputs.qt-install-dir }}
        run: |
          Get-ChildItem -Recurse -Filter *.prl | ForEach-Object {
            $content = Get-Content $_.FullName -Raw
            $content = $content -replace '^QMAKE_PRL_BUILD_DIR.*\r?\n', ''
            $content = $content -replace '\s?[^ ]*\.o', ''
            Set-Content $_.FullName -Value $content
          }

  build-qt-macos:
    runs-on: macos-latest
    outputs:
      qt-install-dir: ${{ steps.set-qt-dir.outputs.qt-install-dir }}
    steps:
      - uses: actions/checkout@v4

      - name: Set QT_INSTALL_DIR
        id: set-qt-dir
        run: echo "qt-install-dir=${{ runner.temp }}/qt-static-macos" >> $GITHUB_OUTPUT

      - name: Cache Qt (macOS)
        id: cache-qt
        uses: actions/cache@v4
        with:
          path: ${{ steps.set-qt-dir.outputs.qt-install-dir }}
          key: qt-static-macos-squiggle-${{ env.QT_VERSION }}-${{ hashFiles('.github/actions/build-qt-squiggle/action.yml') }}-v2
          restore-keys: |
            qt-static-macos-squiggle-${{ env.QT_VERSION }}-

      - name: Install LLVM (macOS)
        if: ${{ steps.cache-qt.outputs.cache-hit != 'true' }}
        run: brew install llvm

      - name: Build static Qt from source (macOS)
        if: ${{ steps.cache-qt.outputs.cache-hit != 'true' }}
        run: |
          mkdir -p ${{ steps.set-qt-dir.outputs.qt-install-dir }}/src
          cd ${{ steps.set-qt-dir.outputs.qt-install-dir }}/src
          git clone https://code.qt.io/qt/qt5.git
          cd qt5
          git checkout v${{ env.QT_VERSION }}
          perl init-repository --module-subset qtbase,qttools,qtimageformats -f  # Removed unnecessary
          mkdir ../build
          cd ../build
          rm -rf ./*  # Clean build dir
          export LLVM_DIR=$(brew --prefix llvm)
          ../qt5/configure -static -opensource -confirm-license -no-pch -skip qtwebengine -nomake tests -nomake examples -make libs -prefix ${{ steps.set-qt-dir.outputs.qt-install-dir }} -D LLVM_INSTALL_DIR="${LLVM_DIR}" -DFEATURE_clang=ON -DFEATURE_clangcpp=ON
          cmake --build . --parallel $(sysctl -n hw.ncpu)
          cmake --install .

      - name: Clean .prl files (remove absolute build paths and .o file libs)
        if: ${{ steps.cache-qt.outputs.cache-hit != 'true' }}
        working-directory: ${{ steps.set-qt-dir.outputs.qt-install-dir }}
        run: |
          echo "Cleaning .prl files in ${{ steps.set-qt-dir.outputs.qt-install-dir }} to fix static linking..."
          find . -type f -name "*.prl" | while read -r file; do
            sed -i '' -e '/^QMAKE_PRL_BUILD_DIR/d' "$file"  # Remove build dir line (absolute paths)
            sed -i '' -E 's| ?[^ ]*\.o||g' "$file"  # Remove any .o paths from libs
          done
          echo ".prl cleaning complete."

  build-squiggle:
    needs: [build-qt-linux, build-qt-windows, build-qt-macos]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            qt-needs: build-qt-linux
            artifact-name: squiggle-linux
            binary-path: packages/squiggle/dist/squiggle
            
          - os: windows-latest
            qt-needs: build-qt-windows
            artifact-name: squiggle-windows
            binary-path: packages/squiggle/dist/squiggle.exe

          - os: macos-latest
            qt-needs: build-qt-macos
            artifact-name: squiggle-macos
            binary-path: packages/squiggle/dist/squiggle

    steps:
      - uses: actions/checkout@v4

      - name: Set Qt Environment Variables
        id: set-qt-env
        shell: bash
        run: |
          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            echo "QT_INSTALL_DIR=${{ needs.build-qt-linux.outputs.qt-install-dir }}" >> $GITHUB_ENV
          elif [ "${{ matrix.os }}" = "windows-latest" ]; then
            echo "QT_INSTALL_DIR=${{ needs.build-qt-windows.outputs.qt-install-dir }}" >> $GITHUB_ENV
          elif [ "${{ matrix.os }}" = "macos-latest" ]; then
            echo "QT_INSTALL_DIR=${{ needs.build-qt-macos.outputs.qt-install-dir }}" >> $GITHUB_ENV
          fi

      - name: Restore Qt from Cache
        uses: actions/cache@v4
        with:
          path: ${{ env.QT_INSTALL_DIR }}
          key: ${{ runner.os == 'Linux' && 'qt-static-linux-squiggle' || (runner.os == 'Windows' && 'qt-static-windows-squiggle' || 'qt-static-macos-squiggle') }}-${{ env.QT_VERSION }}-${{ hashFiles('.github/actions/build-qt-squiggle/action.yml') }}-${{ runner.os == 'Linux' && 'v3' || 'v3' }}
          restore-keys: |
            ${{ runner.os == 'Linux' && 'qt-static-linux-squiggle' || (runner.os == 'Windows' && 'qt-static-windows-squiggle' || 'qt-static-macos-squiggle') }}-${{ env.QT_VERSION }}-

      - name: Install system dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgl1-mesa-dev libfontconfig1-dev libfreetype6-dev \
            libx11-dev libx11-xcb-dev libxext-dev libxfixes-dev libxi-dev libxrender-dev \
            libxcb1-dev libxcb-glx0-dev libxcb-keysyms1-dev libxcb-image0-dev libxcb-shm0-dev \
            libxcb-icccm4-dev libxcb-sync-dev libxcb-xfixes0-dev libxcb-shape0-dev \
            libxcb-randr0-dev libxcb-render-util0-dev libxcb-util-dev libxcb-xinerama0-dev \
            libxcb-xkb-dev libxkbcommon-dev libxkbcommon-x11-dev libatspi2.0-dev \
            libpcre2-dev libdbus-1-dev libpng-dev libjpeg-dev libglib2.0-dev \
            libxcb-cursor-dev libharfbuzz-dev libzstd-dev libxkbcommon-x11-dev

      - name: Install dependencies (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          for ($retry = 1; $retry -le 3; $retry++) {
            choco install strawberryperl ninja llvm jom --yes --no-progress --limit-output
            if ($LASTEXITCODE -eq 0) { break }
            Start-Sleep -Seconds 10
          }

      - name: Setup MSVC environment
        if: matrix.os == 'windows-latest'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
          vsversion: 2022

      - name: Build Squiggle (Linux)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          export PATH="${{ env.QT_INSTALL_DIR }}/bin:$PATH"
          export PKG_CONFIG_PATH="${{ env.QT_INSTALL_DIR }}/lib/pkgconfig:$PKG_CONFIG_PATH"
          chmod -R +x ${QT_INSTALL_DIR}/bin
          chmod -R +x ${QT_INSTALL_DIR}/libexec
          
          cd packages/squiggle
          
          qmake squiggle.pro || { echo "qmake failed"; exit 1; }
          
          make -j$(nproc) || { echo "make failed"; exit 1; }
          mkdir -p dist
          cp squiggle dist/
          strip dist/squiggle

      - name: Build Squiggle (Windows)
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          export PATH="${{ env.QT_INSTALL_DIR }}/bin:$PATH"
          
          cd packages/squiggle
          
          qmake squiggle.pro
          
          if command -v jom >/dev/null; then
            jom /J $(nproc || echo 4)
          else
            nmake
          fi
          
          mkdir dist
          cp release/squiggle.exe dist/squiggle.exe

      - name: Build Squiggle (macOS)
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          export PATH="${{ env.QT_INSTALL_DIR }}/bin:$PATH"
          # Ensure Qt binaries are executable
          chmod -R +x ${QT_INSTALL_DIR}/bin
          chmod -R +x ${QT_INSTALL_DIR}/libexec
          
          cd packages/squiggle
          
          # Use simplified qmake command; all logic is in the .pro file
          qmake squiggle.pro
          
          make -j$(sysctl -n hw.ncpu)
          
          mkdir -p dist
          cp squiggle.app/Contents/MacOS/squiggle dist/
          strip dist/squiggle

      - name: Upload Final Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: ${{ matrix.binary-path }}
