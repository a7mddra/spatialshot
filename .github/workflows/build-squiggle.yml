name: Build Squiggle (Cross-Platform)

on:
  push:
  # workflow_dispatch:

env:
  QT_VERSION: 6.8.0

jobs:
  build-qt-linux:
    runs-on: ubuntu-latest
    outputs:
      qt-install-dir: ${{ steps.set-qt-dir.outputs.qt-install-dir }}
    steps:
      - uses: actions/checkout@v4

      - name: Set QT_INSTALL_DIR
        id: set-qt-dir
        run: echo "qt-install-dir=${{ runner.temp }}/qt-static-linux" >> $GITHUB_OUTPUT

      - name: Cache Qt (Linux)
        id: cache-qt
        uses: actions/cache@v4
        with:
          path: ${{ steps.set-qt-dir.outputs.qt-install-dir }}
          key: qt-static-linux-squiggle-${{ env.QT_VERSION }}-v6
          restore-keys: |
            qt-static-linux-squiggle-${{ env.QT_VERSION }}-

      - name: Install build dependencies (Linux)
        if: ${{ steps.cache-qt.outputs.cache-hit != 'true' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential perl python3 cmake ninja-build git \
            libx11-dev libx11-xcb-dev libxext-dev libxfixes-dev libxi-dev libxrender-dev \
            libxcb1-dev libxcb-glx0-dev libxcb-keysyms1-dev libxcb-image0-dev libxcb-shm0-dev \
            libxcb-icccm4-dev libxcb-sync-dev libxcb-xfixes0-dev libxcb-shape0-dev \
            libxcb-randr0-dev libxcb-render-util0-dev libxcb-util-dev libxcb-xinerama0-dev \
            libxcb-xkb-dev libxkbcommon-dev libxkbcommon-x11-dev libatspi2.0-dev \
            libpcre2-dev libpng-dev libjpeg-dev libglib2.0-dev libwww-perl \
            libxcb-cursor-dev libharfbuzz-dev libzstd-dev

      - name: Build static Qt (Linux)
        if: ${{ steps.cache-qt.outputs.cache-hit != 'true' }}
        run: |
          set -euo pipefail
          QT_SRC="${{ steps.set-qt-dir.outputs.qt-install-dir }}/src"
          rm -rf "$QT_SRC"
          git clone --depth 1 --branch "v${{ env.QT_VERSION }}" https://code.qt.io/qt/qt5.git "$QT_SRC"
          cd "$QT_SRC"
          ./init-repository -f
          git submodule update --init --recursive --depth 1
          rm -rf qt3d qt5compat qtcanvas3d qtcharts qtcoap qtconnectivity qtdatavis3d qtdoc qtfeedback qtgamepad qtgraphs qtgrpc qthttpserver qtlocation qtlottie qtmqtt qtmultimedia qtnetworkauth qtopcua qtpim qtpositioning qtqa qtquick3d qtquick3dphysics qtquickeffectmaker qtquicktimeline qtremoteobjects qtscxml qtsensors qtserialbus qtserialport qtspeech qtsystems qttranslations qtvirtualkeyboard qtwayland qtwebchannel qtwebengine qtwebglplugin qtwebsockets qtwebview qtxmlpatterns
          mkdir -p ../build
          cd ../build
          rm -rf ./*
          ../src/configure -prefix "${{ steps.set-qt-dir.outputs.qt-install-dir }}" -release -static -opensource -confirm-license -no-pch -skip qtwebengine -nomake tests -nomake examples -no-opengl -no-dbus -no-icu -no-glib -no-fontconfig -qt-libjpeg -qt-libpng -qt-freetype -qt-zlib -qt-pcre -qt-harfbuzz -bundled-xcb-xinput -xcb
          cmake --build . --parallel $(nproc)
          cmake --install .

      - name: Clean .prl files (Linux)
        if: ${{ steps.cache-qt.outputs.cache-hit != 'true' }}
        working-directory: ${{ steps.set-qt-dir.outputs.qt-install-dir }}
        run: |
          find . -type f -name "*.prl" | while read -r file; do
            sed -i -e '/^QMAKE_PRL_BUILD_DIR/d' "$file"
            sed -i -E 's| ?[^ ]*\.o||g' "$file"
          done

  build-qt-windows:
    runs-on: windows-latest
    outputs:
      qt-install-dir: ${{ steps.set-qt-dir.outputs.qt-install-dir }}
    steps:
      - uses: actions/checkout@v4

      - name: Set QT_INSTALL_DIR
        id: set-qt-dir
        run: echo "qt-install-dir=${{ runner.temp }}\qt-static-windows" >> $env:GITHUB_OUTPUT

      - name: Cache Qt (Windows)
        id: cache-qt
        uses: actions/cache@v4
        with:
          path: ${{ steps.set-qt-dir.outputs.qt-install-dir }}
          key: qt-static-windows-squiggle-${{ env.QT_VERSION }}-v6
          restore-keys: |
            qt-static-windows-squiggle-${{ env.QT_VERSION }}-

      - name: Install dependencies (Windows)
        if: ${{ steps.cache-qt.outputs.cache-hit != 'true' }}
        shell: powershell
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          for ($retry = 1; $retry -le 3; $retry++) {
            choco install strawberryperl ninja llvm jom --yes --no-progress --limit-output
            if ($LASTEXITCODE -eq 0) { break }
            Start-Sleep -Seconds 10
          }
          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: Setup MSVC environment
        if: ${{ steps.cache-qt.outputs.cache-hit != 'true' }}
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
          vsversion: 2022

      - name: Build static Qt (Windows)
        if: ${{ steps.cache-qt.outputs.cache-hit != 'true' }}
        shell: bash
        run: |
          set -e
          SRC_DIR="${{ steps.set-qt-dir.outputs.qt-install-dir }}/src"
          mkdir -p "$SRC_DIR"
          cd "$SRC_DIR"
          rm -rf qt5
          git clone --depth 1 -b "v${{ env.QT_VERSION }}" https://code.qt.io/qt/qt5.git
          cd qt5
          perl init-repository -f
          git submodule update --init --recursive --depth 1
          rm -rf qt3d qt5compat qtcanvas3d qtcharts qtcoap qtconnectivity qtdatavis3d qtdoc qtfeedback qtgamepad qtgraphs qtgrpc qthttpserver qtlocation qtlottie qtmqtt qtmultimedia qtnetworkauth qtopcua qtpim qtpositioning qtqa qtquick3d qtquick3dphysics qtquickeffectmaker qtquicktimeline qtremoteobjects qtscxml qtsensors qtserialbus qtserialport qtspeech qtsystems qttranslations qtvirtualkeyboard qtwayland qtwebchannel qtwebengine qtwebglplugin qtwebsockets qtwebview qtxmlpatterns
          BUILD_DIR="../build"
          rm -rf "$BUILD_DIR" || true
          mkdir -p "$BUILD_DIR"
          cd "$BUILD_DIR"
          ../qt5/configure.bat -static -opensource -confirm-license -no-pch -skip qtwebengine -nomake tests -nomake examples -make libs -cmake-generator Ninja -prefix "${{ steps.set-qt-dir.outputs.qt-install-dir }}" -platform win32-msvc -qt-zlib -qt-libpng -qt-libjpeg -qt-freetype -qt-pcre -qt-harfbuzz
          cmake --build . --parallel
          cmake --install .

      - name: Clean .prl files (Windows)
        if: ${{ steps.cache-qt.outputs.cache-hit != 'true' }}
        shell: powershell
        working-directory: ${{ steps.set-qt-dir.outputs.qt-install-dir }}
        run: |
          Get-ChildItem -Recurse -Filter *.prl | ForEach-Object {
            $content = Get-Content $_.FullName -Raw
            $content = $content -replace '^QMAKE_PRL_BUILD_DIR.*\r?\n', ''
            $content = $content -replace '\s?[^ ]*\.o', ''
            Set-Content $_.FullName -Value $content
          }

  build-qt-macos:
    runs-on: macos-latest
    outputs:
      qt-install-dir: ${{ steps.set-qt-dir.outputs.qt-install-dir }}
    steps:
      - uses: actions/checkout@v4

      - name: Set QT_INSTALL_DIR
        id: set-qt-dir
        run: echo "qt-install-dir=${{ runner.temp }}/qt-static-macos" >> $GITHUB_OUTPUT

      - name: Cache Qt (macOS)
        id: cache-qt
        uses: actions/cache@v4
        with:
          path: ${{ steps.set-qt-dir.outputs.qt-install-dir }}
          key: qt-static-macos-squiggle-${{ env.QT_VERSION }}-v4
          restore-keys: |
            qt-static-macos-squiggle-${{ env.QT_VERSION }}-

      - name: Install dependencies (macOS)
        if: ${{ steps.cache-qt.outputs.cache-hit != 'true' }}
        run: brew install llvm git perl python3 cmake ninja

      - name: Build static Qt (macOS)
        if: ${{ steps.cache-qt.outputs.cache-hit != 'true' }}
        run: |
          set -euo pipefail
          QT_SRC="${{ steps.set-qt-dir.outputs.qt-install-dir }}/src"
          rm -rf "$QT_SRC"
          git clone --depth 1 --branch "v${{ env.QT_VERSION }}" https://code.qt.io/qt/qt5.git "$QT_SRC"
          cd "$QT_SRC"
          ./init-repository -f
          git submodule update --init --recursive --depth 1
          rm -rf qt3d qt5compat qtcanvas3d qtcharts qtcoap qtconnectivity qtdatavis3d qtdoc qtfeedback qtgamepad qtgraphs qtgrpc qthttpserver qtlocation qtlottie qtmqtt qtmultimedia qtnetworkauth qtopcua qtpim qtpositioning qtqa qtquick3d qtquick3dphysics qtquickeffectmaker qtquicktimeline qtremoteobjects qtscxml qtsensors qtserialbus qtserialport qtspeech qtsystems qttranslations qtvirtualkeyboard qtwayland qtwebchannel qtwebengine qtwebglplugin qtwebsockets qtwebview qtxmlpatterns
          mkdir -p ../build
          cd ../build
          rm -rf ./*
          export LLVM_DIR=$(brew --prefix llvm)
          ../src/configure -static -opensource -confirm-license -no-pch -skip qtwebengine -nomake tests -nomake examples -make libs -prefix "${{ steps.set-qt-dir.outputs.qt-install-dir }}" -D LLVM_INSTALL_DIR="${LLVM_DIR}" -DFEATURE_clang=ON -DFEATURE_clangcpp=ON
          cmake --build . --parallel $(sysctl -n hw.ncpu)
          cmake --install .

      - name: Clean .prl files (macOS)
        if: ${{ steps.cache-qt.outputs.cache-hit != 'true' }}
        working-directory: ${{ steps.set-qt-dir.outputs.qt-install-dir }}
        run: |
          find . -type f -name "*.prl" | while read -r file; do
            sed -i '' -e '/^QMAKE_PRL_BUILD_DIR/d' "$file"
            sed -i '' -E 's| ?[^ ]*\.o||g' "$file"
          done

  build-squiggle:
    needs: [build-qt-linux, build-qt-windows, build-qt-macos]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            qt-needs: build-qt-linux
            artifact-name: squiggle-linux
            binary-path: packages/squiggle/dist/bin/squiggle
          - os: windows-latest
            qt-needs: build-qt-windows
            artifact-name: squiggle-windows
            binary-path: packages/squiggle/dist/bin/squiggle.exe
          - os: macos-latest
            qt-needs: build-qt-macos
            artifact-name: squiggle-macos
            binary-path: packages/squiggle/dist/bin/squiggle

    steps:
      - uses: actions/checkout@v4

      - name: Set Qt Environment Variables
        shell: bash
        run: |
          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            echo "QT_INSTALL_DIR=${{ needs.build-qt-linux.outputs.qt-install-dir }}" >> $GITHUB_ENV
          elif [ "${{ matrix.os }}" = "windows-latest" ]; then
            echo "QT_INSTALL_DIR=${{ needs.build-qt-windows.outputs.qt-install-dir }}" >> $GITHUB_ENV
          elif [ "${{ matrix.os }}" = "macos-latest" ]; then
            echo "QT_INSTALL_DIR=${{ needs.build-qt-macos.outputs.qt-install-dir }}" >> $GITHUB_ENV
          fi

      - name: Restore Qt from Cache
        uses: actions/cache@v4
        with:
          path: ${{ env.QT_INSTALL_DIR }}
          key: ${{ runner.os == 'Linux' && 'qt-static-linux-squiggle' || (runner.os == 'Windows' && 'qt-static-windows-squiggle' || 'qt-static-macos-squiggle') }}-${{ env.QT_VERSION }}-v6

      - name: Install system dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build \
            libx11-dev libx11-xcb-dev libxext-dev libxfixes-dev libxi-dev libxrender-dev \
            libxcb1-dev libxcb-glx0-dev libxcb-keysyms1-dev libxcb-image0-dev libxcb-shm0-dev \
            libxcb-icccm4-dev libxcb-sync-dev libxcb-xfixes0-dev libxcb-shape0-dev \
            libxcb-randr0-dev libxcb-render-util0-dev libxcb-util-dev libxcb-xinerama0-dev \
            libxcb-xkb-dev libxkbcommon-dev libxkbcommon-x11-dev libatspi2.0-dev

      - name: Install dependencies (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          for ($retry = 1; $retry -le 3; $retry++) {
            choco install strawberryperl ninja llvm jom --yes --no-progress --limit-output
            if ($LASTEXITCODE -eq 0) { break }
            Start-Sleep -Seconds 10
          }
          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: Setup MSVC environment (Windows)
        if: matrix.os == 'windows-latest'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
          vsversion: 2022

      - name: Build Squiggle (All Platforms)
        shell: bash
        run: |
          export PATH="${{ env.QT_INSTALL_DIR }}/bin:$PATH"
          export PKG_CONFIG_PATH="${{ env.QT_INSTALL_DIR }}/lib/pkgconfig:$PKG_CONFIG_PATH"
          cd packages/squiggle
          cmake -B build -S . -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -CMAKE_PREFIX_PATH="${{ env.QT_INSTALL_DIR }}" \
            -DQT_STATIC_BUILD=ON
          cmake --build build
          cmake --install build --prefix dist

      - name: Strip binary (Linux & macOS)
        if: matrix.os != 'windows-latest'
        run: strip packages/squiggle/dist/bin/squiggle

      - name: Upload Final Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: ${{ matrix.binary-path }}