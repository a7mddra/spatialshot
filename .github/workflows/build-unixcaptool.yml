name: Build Standalone UnixCapTool

on:
  push:
  # workflow_dispatch:

env:
  QT_VERSION: "6.8.0"

jobs:
  build-linux:
    name: Build Static (Linux)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Free up runner disk space
        run: |
          echo "Initial free space:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          echo "Free space after cleanup:"
          df -h

      - name: Build Static Qt 6 (Linux)
        id: qt-static
        uses: ./.github/actions/build-qt-static
        with:
          version: ${{ env.QT_VERSION }}
          dir: ${{ runner.temp }}/Qt-static
          submodules: "qtbase,qtimageformats,qtwayland"
          configure-args: >-
            -skip qtdeclarative
            -skip qtquick3d
            -skip qtmultimedia
            -skip qtpositioning
            -skip qtserialport
            -skip qtvirtualkeyboard
            -skip qtlanguageserver
            -skip qtwidgets
            -skip qtgraphs
            -skip qtlocation
            -skip qtwebengine
            -skip qtdoc
            -skip qt3d
            -skip qt5compat
            -skip qtactiveqt
            -skip qtcharts
            -skip qtcoap
            -skip qtconnectivity
            -skip qtdatavis3d
            -skip qtwebsockets
            -skip qthttpserver
            -skip qttools
            -skip qtwebchannel
            -skip qtsvg
            -skip qtnetworkauth
      
      - name: Install Runtime Libs for Pkg-Config
        run: |
          # The Qt build action installs -dev packages, but we need
          # them available for the qmake pkg-config step too.
          sudo apt-get update
          sudo apt-get install -y \
            libxcb-glx0-dev libxcb-image0-dev libxcb-icccm4-dev \
            libxcb-sync-dev libxcb-xfixes0-dev libxcb-shape0-dev \
            libxcb-randr0-dev libxcb-render-util0-dev libxcb-util-dev \
            libxcb-xinerama0-dev libxcb-xkb-dev libxkbcommon-dev \
            libxkbcommon-x11-dev libfontconfig1-dev libfreetype6-dev \
            libwayland-dev libegl1-mesa-dev libdbus-1-dev libglib2.0-dev

      - name: Build unixcaptool (Linux)
        working-directory: ./packages/unixcaptool
        run: |
          # Pass the Qt install path to qmake
          ${{ steps.qt-static.outputs.dir }}/bin/qmake6 \
            "QT_INSTALL_DIR=${{ steps.qt-static.outputs.dir }}" \
            build.linux.pro
          make
      
      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: unixcaptool-linux
          path: packages/unixcaptool/unixcaptool

  build-macos:
    name: Build Static (macOS)
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set QT_INSTALL_DIR
        id: set-qt-dir
        run: echo "qt-install-dir=${{ runner.temp }}/qt-static-macos" >> $GITHUB_OUTPUT

      - name: Cache Qt (macOS)
        id: cache-qt
        uses: actions/cache@v4
        with:
          path: ${{ steps.set-qt-dir.outputs.qt-install-dir }}
          key: qt-static-macos-${{ env.QT_VERSION }}-modules-base-imageformats-v1

      - name: Install Dependencies (macOS)
        if: ${{ steps.cache-qt.outputs.cache-hit != 'true' }}
        run: brew install ninja

      - name: Build static Qt 6 from source (macOS)
        if: ${{ steps.cache-qt.outputs.cache-hit != 'true' }}
        run: |
          set -e
          QT_SRC_DIR=${{ steps.set-qt-dir.outputs.qt-install-dir }}/src
          QT_BUILD_DIR=${{ steps.set-qt-dir.outputs.qt-install-dir }}/build
          
          mkdir -p $QT_SRC_DIR
          cd $QT_SRC_DIR
          
          git clone --depth 1 --branch "v${{ env.QT_VERSION }}" https://code.qt.io/qt/qt5.git
          cd qt5
          
          # Build qtbase (for core) AND qtimageformats (for the PNG plugin symbol)
          perl init-repository --module-subset qtbase,qtimageformats -f
          
          mkdir -p $QT_BUILD_DIR
          cd $QT_BUILD_DIR
          
          # Configure Qt 6 (static, release, no-dbus for mac)
          ../src/qt5/configure -prefix "${{ steps.set-qt-dir.outputs.qt-install-dir }}" \
            -release -static -opensource -confirm-license \
            -no-dbus -no-pch -nomake examples -nomake tests \
            -skip qtwebengine -skip qtdeclarative -skip qttools
            
          cmake --build . --parallel $(sysctl -n hw.ncpu)
          cmake --install .
          
      - name: Build unixcaptool (macOS)
        working-directory: ./packages/unixcaptool
        run: |
          # Pass the Qt install path to qmake
          ${{ steps.set-qt-dir.outputs.qt-install-dir }}/bin/qmake \
            "QT_INSTALL_DIR=${{ steps.set-qt-dir.outputs.qt-install-dir }}" \
            build.darwin.pro
          make

      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: unixcaptool-macos
          path: packages/unixcaptool/unixcaptool
