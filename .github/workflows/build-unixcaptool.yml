name: Build unixcaptool Static Binaries

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  QT_VERSION: 6.8.0

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set QT_INSTALL_DIR
        id: set-qt-dir
        run: echo "qt-install-dir=${{ runner.temp }}/Qt-static" >> $GITHUB_OUTPUT

      - name: Cache Qt (Linux)
        id: cache-qt
        uses: actions/cache@v4
        with:
          path: ${{ steps.set-qt-dir.outputs.qt-install-dir }}
          key: qt-static-linux-${{ env.QT_VERSION }}-${{ hashFiles('.github/actions/build-qt-static/action.yml') }}-v1
          restore-keys: |
            qt-static-linux-${{ env.QT_VERSION }}-

      - name: Build static Qt (Linux)
        if: ${{ steps.cache-qt.outputs.cache-hit != 'true' }}
        uses: ./.github/actions/build-qt-static
        with:
          version: ${{ env.QT_VERSION }}
          configure-args: "-no-pch -skip qtwebengine -nomake examples -nomake tests"
          dir: ${{ steps.set-qt-dir.outputs.qt-install-dir }}
          submodules: "qtbase,qtwayland"

      - name: Upload Qt install artifact (Linux, optional for debug)
        uses: actions/upload-artifact@v4
        with:
          name: qt-install-linux
          path: ${{ steps.set-qt-dir.outputs.qt-install-dir }}

      - name: Build unixcaptool (Linux)
        run: |
          export PATH=${{ steps.set-qt-dir.outputs.qt-install-dir }}/bin:$PATH
          export LD_LIBRARY_PATH=${{ steps.set-qt-dir.outputs.qt-install-dir }}/lib:$LD_LIBRARY_PATH
          cd packages/unixcaptool
          qmake build.linux.pro
          make -j$(nproc)

      - name: Upload unixcaptool binary (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: unixcaptool-linux
          path: packages/unixcaptool/unixcaptool

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set QT_INSTALL_DIR
        id: set-qt-dir
        run: echo "qt-install-dir=${{ runner.temp }}/Qt-static" >> $GITHUB_OUTPUT

      - name: Cache Qt (macOS)
        id: cache-qt
        uses: actions/cache@v4
        with:
          path: ${{ steps.set-qt-dir.outputs.qt-install-dir }}
          key: qt-static-macos-${{ env.QT_VERSION }}-v1
          restore-keys: |
            qt-static-macos-${{ env.QT_VERSION }}-

      - name: Install LLVM (macOS)
        if: ${{ steps.cache-qt.outputs.cache-hit != 'true' }}
        run: brew install llvm

      - name: Install libpng (macOS)
        if: ${{ steps.cache-qt.outputs.cache-hit != 'true' }}
        run: brew install libpng

      - name: Build static Qt from source (macOS)
        if: ${{ steps.cache-qt.outputs.cache-hit != 'true' }}
        run: |
          mkdir -p ${{ steps.set-qt-dir.outputs.qt-install-dir }}/src
          cd ${{ steps.set-qt-dir.outputs.qt-install-dir }}/src
          git clone https://code.qt.io/qt/qt5.git
          cd qt5
          git checkout v${{ env.QT_VERSION }}
          perl init-repository --module-subset qtbase -f
          mkdir ../build
          cd ../build
          export LLVM_DIR=$(brew --prefix llvm)
          ../qt5/configure -static -opensource -confirm-license -no-pch -skip qtwebengine -nomake tests -nomake examples -make libs -prefix ${{ steps.set-qt-dir.outputs.qt-install-dir }} -system-libpng -D LLVM_INSTALL_DIR="${LLVM_DIR}" -DFEATURE_clang=ON -DFEATURE_clangcpp=ON
          cmake --build . --parallel $(sysctl -n hw.ncpu)
          cmake --install .

      - name: Upload Qt install artifact (macOS, optional for debug)
        uses: actions/upload-artifact@v4
        with:
          name: qt-install-macos
          path: ${{ steps.set-qt-dir.outputs.qt-install-dir }}

      - name: Build unixcaptool (macOS)
        run: |
          export PATH=${{ steps.set-qt-dir.outputs.qt-install-dir }}/bin:$PATH
          export DYLD_LIBRARY_PATH=${{ steps.set-qt-dir.outputs.qt-install-dir }}/lib:$DYLD_LIBRARY_PATH
          cd packages/unixcaptool
          qmake build.darwin.pro
          make -j$(sysctl -n hw.ncpu)

      - name: Upload unixcaptool binary (macOS)
        uses: actions/upload-artifact@v4
        with:
          name: unixcaptool-macos
          path: packages/unixcaptool/unixcaptool
