name: Build Windows

on:
  workflow_dispatch:
  # push:

env:
  QT_VERSION: '6.6.0'
  QT_VARIANT: 'win64_msvc2019_64'
  SOURCE_DIR: 'packages/capturekit/src'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: 1. Checkout repository
      uses: actions/checkout@v4

    - name: 2. Verify project structure
      run: |
        Write-Host "Project structure:"
        Get-ChildItem -Path packages/capturekit -Recurse | ForEach-Object {
          Write-Host "  $($_.FullName)"
        }
        
        if (-not (Test-Path "${{ env.SOURCE_DIR }}")) {
          Write-Error "Source directory not found: ${{ env.SOURCE_DIR }}"
          exit 1
        }

    - name: 3. Install build prerequisites
      run: |
        Write-Host "Installing prerequisites..."
        
        winget install --id Kitware.CMake --silent --accept-package-agreements
        if (-not (Get-Command cmake -ErrorAction SilentlyContinue)) {
          Write-Error "CMake installation failed"
          exit 1
        }
        
        winget install --id Ninja-build.Ninja --silent --accept-package-agreements
        if (-not (Get-Command ninja -ErrorAction SilentlyContinue)) {
          Write-Error "Ninja installation failed"
          exit 1
        }
        
        python --version
        
        Write-Host "✓ All prerequisites installed" -ForegroundColor Green

    - name: 4. Setup MSVC environment
      uses: ilammy/msvc-dev-cmd@v1

    - name: 5. Run Windows build script
      working-directory: packages/capturekit
      run: |
        Write-Host "Running Windows build script..." -ForegroundColor Cyan
        
        if (-not (Test-Path "PKGBUILD.ps1")) {
          Write-Error "PKGBUILD.ps1 not found in current directory"
          Get-Location
          Get-ChildItem
          exit 1
        }
        
        .\PKGBUILD.ps1
        
        if (-not (Test-Path "dist\drawview.exe")) {
          Write-Error "Build failed - drawview.exe not found"
          exit 1
        }
        
        Write-Host "✓ Build completed successfully" -ForegroundColor Green

    - name: Upload artifact contents
      uses: actions/upload-artifact@v4
      with:
        name: capkit-windows-x64
        path: packages/capturekit/dist/*
        retention-days: 30
