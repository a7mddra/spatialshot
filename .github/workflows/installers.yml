name: Build Permanent Installers

on:
    workflow_dispatch:

permissions:
    contents: write

jobs:
    build-windows-installer:
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install NSIS
              run: |
                  choco install nsis
                  echo "C:\Program Files (x86)\NSIS" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

            - name: Build Installer
              run: pwsh -File packaging/windows/PKGBUILD.ps1

            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: installer-windows
                  path: packaging/windows/SpatialShot_Installer.exe

    build-linux-installer:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-go@v5
              with:
                  go-version: "1.21"

            - name: Build Installer
              run: |
                  chmod +x packaging/linux/PKGBUILD
                  bash packaging/linux/PKGBUILD

            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: installer-linux
                  path: spatialshot-installer

    build-macos-installer:
        runs-on: macos-latest
        steps:
            - uses: actions/checkout@v4

            - name: Build Installer
              run: |
                  chmod +x packaging/macos/PKGBUILD
                  bash packaging/macos/PKGBUILD

            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: installer-macos
                  path: spatialshot-installer.dmg

    publish-installers:
        needs:
            [
                build-windows-installer,
                build-linux-installer,
                build-macos-installer,
            ]
        runs-on: ubuntu-latest
        steps:
            - uses: actions/download-artifact@v4
              with:
                  pattern: installer-*
                  merge-multiple: true

            - name: Zip Artifacts
              run: |
                  zip spatialshot-windows-installer.zip SpatialShot_Installer.exe
                  zip spatialshot-linux-installer.zip spatialshot-installer
                  zip spatialshot-macos-installer.zip spatialshot-installer.dmg

            - name: Update Installers Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: installers
                  name: Permanent Installers
                  body: "These are the permanent bootstrapper installers. They automatically fetch the latest version of SpatialShot."
                  draft: false
                  prerelease: false
                  files: |
                      spatialshot-installer-win-x64.zip
                      spatialshot-installer-linux-x64.zip
                      spatialshot-installer-mac-x64.zip
