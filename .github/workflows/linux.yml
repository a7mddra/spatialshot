name: Build linux

on:
  workflow_dispatch:
  # push:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install base dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake qt6-base-dev zip apt-file
        sudo apt-get install -y --no-install-recommends pkg-config

    - name: Update apt-file database
      run: |
        sudo apt-file update

    - name: Install XCB and related runtime packages (auto-discover via apt-file)
      shell: bash
      run: |
        PKGFILE=packages/capturekit/PKGBUILD
        if [ ! -f "$PKGFILE" ]; then
          echo "PKGBUILD not found at $PKGFILE"; exit 0
        fi

        # Extract entries from XCB_LIB_BASENAMES array in the PKGBUILD
        mapfile -t XCB_LIBS < <(awk '/^XCB_LIB_BASENAMES/ {in=1; next} in && /^\)/ {exit} in {gsub(/["]/,""); print}' "$PKGFILE" | sed 's/^[[:space:]]*//; s/[[:space:]]*$//' | tr -d '\n')

        # awk extraction may produce a single line like: libA libB ... so split
        if [ "${#XCB_LIBS[@]}" -eq 1 ]; then
          read -r -a XCB_LIBS <<< "${XCB_LIBS[0]}"
        fi

        echo "Detected XCB lib basenames: ${XCB_LIBS[*]}"

        for lib in "${XCB_LIBS[@]}"; do
          # Remove any trailing whitespace
          lib=$(echo "$lib" | tr -d '[:space:]')
          if [ -z "$lib" ]; then
            continue
          fi
          echo "Searching packages that provide $lib"
          # Use apt-file to find packages that contain this exact filename
          pkgs=$(apt-file search --regexp "/${lib}$" 2>/dev/null | cut -d: -f1 | sort -u)
          if [ -n "$pkgs" ]; then
            echo "Found packages for $lib: $pkgs"
            echo "Installing packages: $pkgs"
            sudo apt-get install -y --no-install-recommends $pkgs || true
          else
            echo "No packages found via apt-file for $lib (will skip)."
          fi
        done

    - name: Make PKGBUILD executable
      run: chmod +x packages/capturekit/PKGBUILD

    - name: Run build script
      working-directory: packages/capturekit
      run: bash ./PKGBUILD

    - name: Upload artifact contents
      uses: actions/upload-artifact@v4
      with:
        name: capkit-linux-x64
        path: packages/capturekit/dist/*
