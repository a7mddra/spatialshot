name: Build Windows Release

on:
  workflow_dispatch:
  
  push:
    branches:
      - main
      - master

defaults:
  run:
    shell: pwsh

jobs:
  build-windows:
    runs-on: windows-latest
    
    env:
      QT_PATH: C:\Qt\6.6.0\msvc2019_64
      CMAKE_GENERATOR: Ninja
      CMAKE_BUILD_TYPE: Release
      SOURCE_DIR: packages/capturekit/src

    steps:
      - name: 1. Check out repository code
        uses: actions/checkout@v4

      - name: 2. Set up Python (for aqt)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 3. Install aqt (Qt installer)
        run: pip install aqtinstall

      - name: 4. Install Qt 6.6.0 (msvc2019_64)
        run: |
          aqt install-qt windows desktop 6.6.0 win64_msvc2019_64 --archives 7z --outputdir C:\Qt

      - name: 4.5. Set up MSVC Developer Environment
        uses: microsoft/setup-msbuild@v2
        with:
          msbuild-architecture: x64

      - name: 4.6. Setup MSVC Developer Command Prompt
        uses: ilammy/msvc-dev-cmd@v1

      - name: 5. Configure CMake
        run: |
          cmake -S ${{ env.SOURCE_DIR }} -B build `
            -G "${{ env.CMAKE_GENERATOR }}" `
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} `
            -DCMAKE_PREFIX_PATH=${{ env.QT_PATH }}

      - name: 6. Build with CMake/Ninja
        run: |
          cmake --build build

      - name: 7. Create distribution directory
        run: New-Item -ItemType Directory -Path "dist" -Force

      - name: 8. Copy executable to dist
        run: Copy-Item -Path "build\drawview.exe" -Destination "dist\"

      - name: 9. Run windeployqt
        run: |
          $env:PATH = "${{ env.QT_PATH }}\bin;$env:PATH"
          cd dist
          windeployqt drawview.exe
          
          Get-ChildItem
          Get-ChildItem -Recurse
        
      - name: 10. Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: drawview-windows-x64
          path: dist/